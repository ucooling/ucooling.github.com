<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>马立斌技术博客</title>
  <meta name="author" content="Malrin">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ucooling.github.io/">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="马立斌技术博客" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://ucooling.github.io/">
  <meta property="og:title" content="马立斌技术博客">
  

  <script src="/javascripts/libs/jquery/jquery-2.1.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">


  
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  

</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      
      <div id="banner-image">
        <div class="layer">
          <div id="banner-text">
            <h1 class="page-title">马立斌技术博客</h1>
            <p class="page-desc">
              学会蹲下才能跳的更高.<br>
            </p>
            <br>
            <br>
            <div class="page-links center">
              <ul class="index-nav">
                  <li ><a href="/">项目</a></li>
<li ><a href="/blog/archives">目录</a></li>
<li ><a href="/about">关于我</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content">
    <div class="blog-index" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="马立斌技术博客" />
    
    <meta itemprop="url" content="http://ucooling.github.io" />
      
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2017-02-15T16:24:42+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2017/02/15/es6zhong-de-promise/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://ucooling.github.io/blog/2017/02/15/es6zhong-de-promise/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2017/02/15/es6zhong-de-promise/" itemprop="url">ES6中的Promise</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>去年ES6正式发布，这次发布将Promise也正式列入了规范，虽然很多的库或者框架已经对Promise做了很好的封装，但是还是很有必要深入的理解它的概念和使用方法。</p>

<h2>什么是Promise</h2>

<p>很多人在开始学习一个新知识之前都会问自己这个问题，对于很多的新手也许就会掉进这个魔咒，因为网上有很多文章在讲Promise是什么，但是讲的都似是而非，读起来似乎明白了又好像没太理解。其实很简单Promise也是一个JavaScript对象，你只需要console出来不就知道是什么了，就是这么粗暴。</p>

<p><img src="/images/Promise.png" alt="console.log(Promise)" /></p>

<p>这样一看就很简单，Promise就是一个JavaScript对象，自己有all、resolve、reject等这几个方法，原型链上有then、catch等方法。</p>

<h2>小试Promise</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var promise = new Promise(resolve, reject) {
</span><span class='line'>  //这里可以实现一个异步操作
</span><span class='line'>  //resolve是异步操作成功时的回调
</span><span class='line'>  //reject是异步操作失败时的回调
</span><span class='line'>  setTimeout(function(){
</span><span class='line'>      console.log("执行完成");
</span><span class='line'>      resolve('异步执行成功的回调');
</span><span class='line'>  }, 1000);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>上边这段代码实现了一个Promise，对于Promise对象接受一个参数，是一个函数，并且这个函数需要传入两个参数resolve(成功时的回调)、reject(失败时的回调)。这段代码执行一个异步操作。1秒后输出“执行完成”，并且调用resolve方法。</p>

<p>看到这里可能有的人问了这样跟普通的回调有什么区别，不要着急，接下来就讲。
对于传统的回调函数，如果只是简单的一次回调，ok那没有任何问题，但是对于一个很大的系统，代码库非常的复杂，回调会很深，如果你遇到这样的问题肯定深有体会。看这样的代码真是想死的心都有。但是如果通过Promise来实现的话，就可以通过调用then方法链式调用。下边是一个例子：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function tryAsync() {
</span><span class='line'>  var promise = new Promise(resolve, reject) {
</span><span class='line'>      //这里可以实现一个异步操作
</span><span class='line'>      //resolve是异步操作成功时的回调
</span><span class='line'>      //reject是异步操作失败时的回调
</span><span class='line'>      setTimeout(function(){
</span><span class='line'>          console.log("执行完成");
</span><span class='line'>          resolve('异步执行成功的回调');
</span><span class='line'>      }, 1000);
</span><span class='line'>  }
</span><span class='line'>  return promise;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>tryAsync().then(function(data){console.log(data)}).then().then()...
</span></code></pre></td></tr></table></div></figure>


<h2>resolve、reject用法</h2>

<p>到这里应该对Promise有了一个基本的认识，那么现在我们来看看resolve和reject的用法，其实他们就是成功时的回调，和失败时的回调。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function getNumber() {
</span><span class='line'>  var promise = new Promise(resolve, reject) {
</span><span class='line'>      setTimeout(function(){
</span><span class='line'>          var num = Math.ceil(Math.random()*10);
</span><span class='line'>          if(num &gt; 5){
</span><span class='line'>              resolve();
</span><span class='line'>          }else {
</span><span class='line'>              reject()
</span><span class='line'>          }
</span><span class='line'>      }, 1000)
</span><span class='line'>  };
</span><span class='line'>  
</span><span class='line'>  return promise;
</span><span class='line'>}
</span><span class='line'>getNumber().then(
</span><span class='line'>  function(data){
</span><span class='line'>      console.log('resolved');
</span><span class='line'>      console.log(data);
</span><span class='line'>  },
</span><span class='line'>  function(reason, data){
</span><span class='line'>      console.log('reject');
</span><span class='line'>      console.log(reason);
</span><span class='line'>  }
</span><span class='line'>)</span></code></pre></td></tr></table></div></figure>


<p>getNumber函数用来异步获取一个数字，1秒后执行完成，如果数字小于5，就代表我们执行了resolve函数，修改Promise的状态。否则就是失败了，调用reject方法。</p>

<h2>总结</h2>

<p>其实Promise还提供了类似all、race、catch等方法，用法基本类似，网上也有很多的参考资料，不再赘述。</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2017-02-09T11:14:52+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2017/02/09/simple-asset-helper-function-for-cdn/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://ucooling.github.io/blog/2017/02/09/simple-asset-helper-function-for-cdn/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2017/02/09/simple-asset-helper-function-for-cdn/" itemprop="url">如何给css文件中的图片做CDN</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h2>背景</h2>

<p>通常我们为了提高网站的速度，会将站点的图片、css、以及一些库文件做CDN。对于页面中的图片的静态资源很简单，只需要修改资源的URL即可。但是对于scss文件中的图片或者svg资源怎么做CDN，很多人就不知道了，最近也是有这个需求所以自己就去探索了一下，其实也很简单。下面我们就一步一步实现。</p>

<ul>
<li>定义变量</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$asset-base-path: '../assets' !default;</span></code></pre></td></tr></table></div></figure>


<p>可以将这个变量提到一个config文件中。这里是定义了一个资源的基地址。</p>

<ul>
<li>实现方法</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@function asset($type, $file) {
</span><span class='line'>  @return url($asset-base-path + '/' + $type + '/' + $file);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>调用</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@function image($file) {
</span><span class='line'>  @return asset('images', $file);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>在scss中调用</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.foo {
</span><span class='line'>  background-image: image('kittens.png');
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>备注</h4>

<p>改博客只做备忘。<a href="https://css-tricks.com/snippets/sass/simple-asset-helper-functions/">参考</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-04-03T09:53:55+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/04/03/elk-log-analysis/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://ucooling.github.io/blog/2016/04/03/elk-log-analysis/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/04/03/elk-log-analysis/" itemprop="url">轻量 高效 日志分析架构ELK(elasticsearh+logstash+Kibana)</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>随着互联网时代的快速发展，以及大数据时代的到来，对于大数据的收集分析处理，以及用户测试开始变的尤为重要，也是很多公司在探索的方向。
所以在开始本博文之前我觉得很有必要解释依稀什么是ELK，只有有一个清晰的认识，这样在使用的时候才会更加的得心应手。</p>

<h2>什么是Elasticsearch</h2>

<p>Elasticsearch是一个基于Apacha Lucene&trade;的开源搜索引擎，在开源搜索领域它一直被认为是迄今为止最先进、性能最好、功能最全的搜索引擎。Elasticsearch是使用Java语言开发并且使用Lucene作为核心来实现的以及使用简单的RESTful来隐藏Lucene的复杂性，让全文搜索变的很简单。
其实通俗的我们可以用关系型数据库来和Elasticsearch作比较。他提供的很多功能都和关系型数据库比较类似。</p>

<ul>
<li><p>索引(Index)
ES用来存储数据的逻辑区域，类似于关系型数据库中的Database.</p></li>
<li><p>类型(Type)
面向查询是，一个Index钟可能会有若干个Type，这个Type可以跟关系型数据库中的Table类似.</p></li>
<li><p>文档(Document)
Document是具体的存储实体，存储形式为JSON，类似于关系数据库中的某一条记录。它可以被存放在Index中或者Type中，不过当存放在Index中时必须保证它被存放在某个Type类型中，即组成一个Document Type.</p></li>
<li><p>映射(Mapping)
Mapping是实际字段的映射关系，可以理解成Table的定义描述，可以理解成Table的定义描述，即Table Schema</p></li>
</ul>


<p>综上所述： 三者的关系就是 index > type > document</p>

<p>ES最主要的最主要的功效就是检索查询，所以能否挖掘ES的强大之处就在于能否用好其自带的Query DSL, 这里的Query也可以类比到关系型数据库中的SQL语句，在某种意义上他们都是属于DSL的范畴，前者Query DSL是为了解决ES的检索问题而设立的，后者SQL则是为了处理关系型数据库的查询。</p>

<p>ES的官网提供了很详细的<a href="http://es.xiaoleilu.com/index.html">文档</a>供我们学习</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-03-17T17:39:01+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/03/17/pact/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://ucooling.github.io/blog/2016/03/17/pact/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/03/17/pact/" itemprop="url">Pact 测试</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h3>什么是Pact测试</h3>

<p>前几天一直在给我们的系统添加Pact测试，也就系统的去学习了一下什么是Pact测试，其实之前也知道一点，但是知道的不透彻，只是知道他是一个合约测试。以下是官方的解释：</p>

<blockquote><p>Enables consumer driven contract testing, providing a mock service and DSL for the consumer project, and interaction playback and verification for the service provider project.</p></blockquote>

<p>其实简单的说：Consumer端通过mock一个provider服务，然后模仿自己调用API接口的请求，然后写一些测试API接口的case，在consumer端通过run pact测试，会生成一个json文件，这个文件就是生成的合约，
这个时候你可以定义一个远程的服务，将这个json文件发布上去。然后在Consumer端，当run pact测试时，将会去从这个远程的服务上拿到这个json文件来测试自己的API接口。
下面这幅图是从官网上拿到的：</p>

<p><img src="/images/pact_two_parts.png" alt="Pact原理图" /></p>

<h3>例子</h3>

<h4>Consumer端</h4>

<ul>
<li>引入Gem包</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'pact-mock_service'
</span><span class='line'>gem 'sass'
</span><span class='line'>
</span><span class='line'>group :development, :test do
</span><span class='line'>  gem 'rake'
</span><span class='line'>  gem 'pact'
</span><span class='line'>  gem 'pact_broker-client'
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<ul>
<li>引入Npm包</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"pact-consumer-js-dsl": "^0.1.3"</span></code></pre></td></tr></table></div></figure>


<ul>
<li>写测试case</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var pact = require('pact-consumer-js-dsl');
</span><span class='line'>
</span><span class='line'>describe('provider api', function () {
</span><span class='line'>
</span><span class='line'>  var provider;
</span><span class='line'>
</span><span class='line'>  beforeEach(() =&gt; {
</span><span class='line'>    provider = pact.mockService({
</span><span class='line'>      consumer: 'Pact frontend',
</span><span class='line'>      provider: 'Pact backend',
</span><span class='line'>      port: 9429,
</span><span class='line'>      done: (error) =&gt; {expect(error).toBeNull();}
</span><span class='line'>    });
</span><span class='line'>  });
</span><span class='line'>
</span><span class='line'>  it('post a request', function (done) {
</span><span class='line'>    provider
</span><span class='line'>      .uponReceiving("a Request a callback enquiry")
</span><span class='line'>      .withRequest({
</span><span class='line'>        method: "post",
</span><span class='line'>        path: "/provider/route1",
</span><span class='line'>        headers: {
</span><span class='line'>          "Origin": "http://localhost:9876"
</span><span class='line'>        },
</span><span class='line'>        body: 'name=nameTest&password=passwordTest'
</span><span class='line'>      })
</span><span class='line'>      .willRespondWith({
</span><span class='line'>        status: 201,
</span><span class='line'>        headers: {
</span><span class='line'>          'Access-Control-Allow-Origin': 'http://localhost:9876',
</span><span class='line'>          'Access-Control-Allow-Methods': 'POST'}
</span><span class='line'>      });
</span><span class='line'>
</span><span class='line'>    provider.run(done, function (runComplete) {
</span><span class='line'>      var stubProviderApi = {
</span><span class='line'>        'name': 'nameTest',
</span><span class='line'>        'password': 'passwordTest'
</span><span class='line'>      };
</span><span class='line'>      var providerSuccess = function () {
</span><span class='line'>        runComplete();
</span><span class='line'>      };
</span><span class='line'>      var providerError = function (data) {
</span><span class='line'>        runComplete();
</span><span class='line'>        expect(false).toBeTruthy();
</span><span class='line'>      };
</span><span class='line'>      # 在前端调用
</span><span class='line'>      Provider.save(stubProviderApi, providerSuccess, providerError);
</span><span class='line'>    });
</span><span class='line'>  });
</span><span class='line'>
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<p>当跑上边的测试case将会生成一个json的文件，下面需要去配置pact来发布这个json文件到一个服务</p>

<ul>
<li>配置pact</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>require 'pact_broker/client/tasks'
</span><span class='line'>
</span><span class='line'>PactBroker::Client::PublicationTask.new do | task |
</span><span class='line'>  task.consumer_version = ENV['PactVersion']
</span><span class='line'>  task.pact_broker_base_url = "http://store_contracts_json_file_wed_site.com"
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<ul>
<li>发布这个json文件</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle exec rake pact:publish</span></code></pre></td></tr></table></div></figure>


<ul>
<li>在provider端引入Gem包</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'pact'</span></code></pre></td></tr></table></div></figure>


<ul>
<li>配置pact json的地址在provider端</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Pact.service_provider "Investor API" do
</span><span class='line'>   honours_pact_with "Investor APP" do
</span><span class='line'>   pact_server="http://store_contracts_json_file_wed_site.com"
</span><span class='line'>   pact_path="/pacts/provider/Pact backend/consumer/Pact frontend/latest"
</span><span class='line'>
</span><span class='line'>   pact_uri URI.encode("#{pact_server}#{pact_path}")
</span><span class='line'>   end
</span><span class='line'> end </span></code></pre></td></tr></table></div></figure>


<ul>
<li>取json文件并验证API接口</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake pact:verify</span></code></pre></td></tr></table></div></figure>


<h3>参考</h3>

<p><a href="https://github.com/realestate-com-au/pact">Github 地址</a>
<a href="http://ucooling.github.io/blog/2016/03/17/pact/">博客地址</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-09T16:49:56+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/09/new-relic-in-ruby-application/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://ucooling.github.io/blog/2016/01/09/new-relic-in-ruby-application/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/09/new-relic-in-ruby-application/" itemprop="url">New Relic in Ruby Application</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h2>背景</h2>

<p>随着互联网、以及移动互联领域的快速发展，可以说现在互联网已经无处不在，人们对于互联网的性能也越来越挑剔，如果网站速度太慢，发生错误的频率太高，这些因素都会使用户对网站失去信心，所以必须实时去检测网站的运行状况。New Relic就是一个对网站的性能进行检测的工具，它能够检测网站的响应速度，用户的满意度，错误发生的频率等。</p>

<h2>介绍</h2>

<p><a href="https://ruby-china.org/topics/22379">这里</a>有一篇很好的介绍，我就不再复述了。</p>

<h2>如何使用</h2>

<p>本文主要是针对在Ruby项目上的使用</p>

<ul>
<li><p>引入New Relic到你的应用</p>

<pre><code>gem 'newrelic_rpm'
</code></pre></li>
<li><p><a href="http://newrelic.com/">注册</a>一个New Relic账号</p></li>
<li>下载newrelic.yml文件</li>
<li>在本地环境使用New Relic工具</li>
</ul>


<p> 1 在boot.rb文件中引入下面的代码：</p>

<pre><code class="```">   require 'newrelic_rpm'
</code></pre>

<p> 2 配置newrelic.yml文件</p>

<pre><code class="```">   development:
         &lt;&lt;: *default_settings
         monitor_mode: true
         developer_mode: true
</code></pre>

<p> 3 配置要检测的网站
   这里后台框架使用的是Web machine, 所以它的配置是这样的。如果使用的是其它的框架，应该根据框架的不同去进行不同的设置。</p>

<pre><code class="```">   use NewRelic::Rack::DeveloperMode
     use Rack::HalBrowser::Redirect, :exclude =&gt; ['/trace', '/products/diagnostic',         '/service-info', '/newrelic'] # /trace is for Webmachine
</code></pre>

<p> 4 当错误发生是如何发生报警
 这里可以用两种选择，因为New Relic 他只能对于程序的所有错发发生频率报警，只有当测序发生的错误频率高于配置测报警率的时候就会报警，报警的方式可以使发邮件或者slack或者PageDuty等。他不会对某一个特殊的错误进行报警，也不会对HTTP请求进行报警。
 告诉New Relic程序发生错误的方式有两种：</p>

<ul>
<li>显式的在程序中抛出异常。</li>
<li>调用New Relic 的API</li>
</ul>


<pre><code class="`"> require 'new_relic/agent/transaction’
 NewRelic::Agent.notice_error(msg)
</code></pre>

<p> 总之，New Relic是一个非常有用的工具。这里只是简单地介绍了一下New Relic的基本功能和用法，更多高级的功能还需要大家去发掘。</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-08T13:49:51+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/08/use-elasticsearch-to-rails/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://ucooling.github.io/blog/2016/01/08/use-elasticsearch-to-rails/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/08/use-elasticsearch-to-rails/" itemprop="url">Use Elasticsearch to Rails</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h3>Elasticsearch introduce</h3>

<p>If you build a website, maybe you want to add search to your application, but it is different to run a search function, you must solve a lot of questions, for example search speed, real-time. so elasticsearch is a cool tool, it can solve all questions of above, it have a advertise, let to search sample.</p>

<p>This is a sample demo, it will build a rails application that will use elasticsearch</p>

<h3>Install Elasticsearch</h3>

<ul>
<li>for Mac labtop:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>brew install elasticsearch</span></code></pre></td></tr></table></div></figure>


<ul>
<li>start elasticsearch in the local environment:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>elasticsearch --config=/usr/local/opt/elasticsearch/config/elasticsearch.yml</span></code></pre></td></tr></table></div></figure>


<p>Now you can visit <a href="http://localhost:9200">http://localhost:9200</a> url, if success, it&rsquo;s means you already install elacticsearch successful, just attention, you need to install jdk firstly, at the same time, the jdk version must > 1.8.</p>

<h3>Build a rails application</h3>

<p>This bolg just build a sample a single table application</p>

<ul>
<li>build application</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails new blog_elasticsearch</span></code></pre></td></tr></table></div></figure>


<ul>
<li>install gem package</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle instal</span></code></pre></td></tr></table></div></figure>


<ul>
<li>use scaffold build application</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails g scaffold article title:string text:text</span></code></pre></td></tr></table></div></figure>


<ul>
<li>generate db table</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake db:migrate</span></code></pre></td></tr></table></div></figure>


<h3>Use elasticsearch to application</h3>

<ul>
<li>add below gem to your Gemfile</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'elasticsearch-model' gem 'elasticsearch-rails'</span></code></pre></td></tr></table></div></figure>


<ul>
<li>when import elacticsearch, you want to search your db data, there ask you must add index to you table of you want to search. commond line is(if you want to run this command, you must run you elacticsearch in your local environment)</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake environment elasticsearch:import:model CLASS='Article' BATCH=100 FORCE=y</span></code></pre></td></tr></table></div></figure>


<ul>
<li>add below code to your /lib/tasks/elasticsearch.rake file</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>require 'elasticsearch/rails/tasks/import'</span></code></pre></td></tr></table></div></figure>


<ul>
<li>It is still available if you hope to, when you update your db data, you need to add below code your model that is you search</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>include Elasticsearch::Model
</span><span class='line'>include Elasticsearch::Model::Callbacks</span></code></pre></td></tr></table></div></figure>


<h3>Community</h3>

<ul>
<li><a href="http://makeiteasy.github.io/2015/05/19/use-elasticsearch-in-rails.html">http://makeiteasy.github.io/2015/05/19/use-elasticsearch-in-rails.html</a></li>
<li><a href="http://blog.bringstudio.com/zheng-he-elasticsearchdao-xian-you-railsxiang-mu/">http://blog.bringstudio.com/zheng-he-elasticsearchdao-xian-you-railsxiang-mu/</a></li>
</ul>

</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-09-23T21:23:34+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2015/09/23/heatmap/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://ucooling.github.io/blog/2015/09/23/heatmap/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015/09/23/heatmap/" itemprop="url">Heatmap</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><ul>
<li><p>list all options</p>

<p>we have investgated below options:</p>

<p>1 Visual Website Optimizer</p>

<p>2 inspectlet</p>

<p>3 luckyorange</p>

<p>4 heatmap.me</p>

<p>5 mouseflow</p></li>
<li><p>why use heatmap.me</p>

<p>For the Visual Website Optimizer, it use canvas draw a page and record user heatmap. For inspectlet and luckyorange, they use a static image record user heatmap, but need record user&rsquo;s operations in our widget. So Thvm</p></li>
<li><p>how to use</p></li>
<li>disadvantaged</li>
</ul>


<h2>Heat Map Spike</h2>

<h3>Problem:</h3>

<p> Most of the heatmap tool is a url based tool, that means it will provide us a snapshot of the page and show the heatmap on the snapshot. They all have less support to dynamic elements such as our HLT, none of them can show the HLT on the snapshot and the click events is shown as a PDP click.</p>

<p> We&rsquo;ve tried vwo, openheatmap, inspectlet, mouseflow, luckyorange, crazyegg, none of them can be used for our HLT.</p>

<h3>Options:</h3>

<ol>
<li><p>Heatmap.me</p>

<ul>
<li><p>This tool provide good support for dynamic elements, also provide a way to prevent count in the events on PDP page.</p></li>
<li><p>The feature is less than other tools, it only collect click events.</p></li>
<li>Don&rsquo;t have a dashboard show results.</li>
</ul>
</li>
<li><p>vwo</p>

<ul>
<li>This tool does not support for dynamic elements</li>
<li>Just apply click events.</li>
<li>Have a good dashboard show results.</li>
<li>use canvas draw result page.</li>
</ul>
</li>
<li><p>inspectlet</p>

<ul>
<li>This tool provide a lot of features, such as Eye-tracking Heatmap/Click Heatmap/scroll Heatmap.</li>
<li>Have a good dashboard show results.</li>
<li>use static image record results.
This tool does not support for dynamic elements</li>
</ul>
</li>
<li><p>luckyorange</p>

<ul>
<li>This tool support move/click/scroll/precise heatmap.</li>
<li>Have a good dashboard show results</li>
<li>use static image record results</li>
<li>This tool does not support for dynamic elements</li>
</ul>
</li>
<li><p>mouseflow</p>

<ul>
<li>This tool support move/click/scroll heatmap.</li>
<li>Have a good dashboard show results</li>
<li>support dynamic elements</li>
<li>Can&rsquo;t load our widget</li>
</ul>
</li>
</ol>

</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-09-23T21:20:52+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2015/09/23/brightcove/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://ucooling.github.io/blog/2015/09/23/brightcove/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015/09/23/brightcove/" itemprop="url">Brightcove</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h2>What is brightcove</h2>

<p>  Brightcove revolutionizes the way organizations deliver video experiences. it change the video transmission ways. It is different the YouTube video, YouTube focus on the video of users homemade. The brightcove hope build a chance, there is everyone can build the video, meantime share the video and get revenue. Brightcove is position itself as an online video paltform, the main work is to provide video and other digital media and publish paltform to manufacturers of video content, totally that is cloud video</p>

<p> ## How to use brightcove</p>

<p> you need to sign up a account of brightcove
 * you can upload a video to media, chose the video that is updated, and click publish button and publish your video</p>

<ul>
<li><p>you also can create a player, when you pushlish your video, you can chose <br/>
you player</p></li>
<li><p>you also create a playlist, and add some video to the playlist, besides you can publish the playlist.</p></li>
</ul>


<p> ## Demo</p>

<ul>
<li>publish a video</li>
</ul>


<p> Use iframe tag</p>

<pre><code class="```">&lt;!doctype html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;title&gt;Dynamically Load Player&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;iframe src='http://players.brightcove.net/4446402108001/ee7a42d1-6d38-46f1-a79e-738e08b6ef36_default/index.html?videoId=4446806003001' allowfullscreen webkitallowfullscreen mozallowfullscreen&gt;&lt;/iframe&gt;
&lt;/body&gt;
&lt;/html&gt;  
</code></pre>

<p>  Use video tag</p>

<p>  ```
&lt;!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dynamically Load Player</title>
</head>
<body>
  <video
  data-video-id="4448133659001"
  data-account="4446402108001"
  data-player="default"
  data-embed="default"
  class="video-js" controls></video></p>

<script src="http://players.brightcove.net/1719543778001/vttjs/dist/vtt.min.js"></script>


<script src="http://players.brightcove.net/4446402108001/default_default/index.min.js"></script>


<p></body>
</html>
```</p>

<ul>
<li>publish a playlist</li>
</ul>


<pre><code class="`"> &lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Media API Sample&lt;/title&gt;
        &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;
    &lt;!-- Javascript Media API wrapper from http://docs.brightcove.com/en/video-cloud/open-source/index.html --&gt;
    &lt;script type="text/javascript" src="http://files.brightcove.com/bc-mapi.js"&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Media API Sample&lt;/h1&gt;
    &lt;!-- Start of Brightcove Player --&gt;
    &lt;script language="JavaScript" type="text/javascript" src="http://admin.brightcove.com/js/BrightcoveExperiences.js"&gt;&lt;/script&gt;
    &lt;object id="myExperience" class="BrightcoveExperience"&gt;
      &lt;param name="bgcolor" value="#FFFFFF" /&gt;
      &lt;param name="width" value="480" /&gt;
      &lt;param name="height" value="270" /&gt;
      &lt;param name="playerID" value="921267190001" /&gt;
      &lt;param name="playerKey" value="AQ~~,AAAA1oy1bvE~,ALl2ezBj3WG3MLvDx9F9zkV06cNK00ey" /&gt;
      &lt;param name="isVid" value="true" /&gt;
      &lt;param name="isUI" value="true" /&gt;
      &lt;param name="dynamicStreaming" value="true" /&gt;
      &lt;!-- params for Universal Player API --&gt;
      &lt;param name="includeAPI" value="true" /&gt;
      &lt;param name="templateReadyHandler" value="BCL.onTemplateReady" /&gt;
    &lt;/object&gt;
    &lt;script type="text/javascript"&gt;brightcove.createExperiences();&lt;/script&gt;
    &lt;!-- End of Brightcove Player --&gt;
    &lt;fieldset&gt;
      &lt;legend&gt;Videos&lt;/legend&gt;
      &lt;div id="results"&gt;&lt;/div&gt;
    &lt;/fieldset&gt;&lt;br&gt;
    &lt;!-- This is the script to modify for the exercise --&gt;
    &lt;script type="text/javascript"&gt;
      // BCL Media API search maker -- adapted from JS-MAPI on http://docs.brightcove.com/en/video-cloud/open-source/index.html
      // namespace to keep all the "global" vars together
      var BCL = {};
      // placeholder - params for API call
      BCL.params = {};
      // Media API read token
      BCMAPI.token = "WDGO_XdKqXVJRVGtrNuGLxCYDNoR-SvA5yUqX2eE6KjgefOxRzQilw..";
      // set the callback for Media API calls
      BCMAPI.callback = "BCL.onSearchResponse";
      // set the filter
      BCL.params.any = "tag:nature";
      BCMAPI.search(BCL.params);
      BCL.onSearchResponse = function(jsonData) {
        var str = "";
        for (var index in jsonData.items) {
          str += "&lt;a onclick=\"BCL.playVideo(" + jsonData.items[index].id + ")\" style=\"cursor:pointer\"&gt;&lt;img src=\"" + jsonData.items[index].thumbnailURL + "\"/&gt;&lt;br/&gt;&lt;small&gt;" + jsonData.items[index].name + "&lt;/&lt;small&gt;&lt;/a&gt;&lt;hr/&gt;";
        }
        document.getElementById("results").innerHTML = str;
      }
      // Player API scripting
      // event listener for the player being ready
      BCL.onTemplateReady = function (event) {
        BCL.player = brightcove.api.getExperience("myExperience");
        // get a reference to the video player
        BCL.videoPlayer = BCL.player.getModule(brightcove.api.modules.APIModules.VIDEO_PLAYER);
      }
      // play video function
      BCL.playVideo = function(videoID) {
        BCL.videoPlayer.loadVideoByID(videoID);
      }
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p> ## reference material</p>

<ul>
<li><a href="http://docs.brightcove.com/en/index.html">http://docs.brightcove.com/en/index.html</a></li>
<li><a href="https://studio.brightcove.com/products/videocloud/home">https://studio.brightcove.com/products/videocloud/home</a></li>
<li><a href="https://docs.brightcove.com/en/video-cloud/cms-api/getting-started/overview-cms.html#generalInfo">https://docs.brightcove.com/en/video-cloud/cms-api/getting-started/overview-cms.html#generalInfo</a></li>
</ul>

</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-05-21T22:16:31+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2015/05/21/how-to-use-sinatra/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://ucooling.github.io/blog/2015/05/21/how-to-use-sinatra/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015/05/21/how-to-use-sinatra/" itemprop="url">How to Use Sinatra</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>这两天是公司的Hack Day,非常有意义的活动，对于本次的idea不做赘述，这篇博客记录一下在整个的Hack过程中如何使用sinatra来搭建一个后台的服务。</p>

<h2>什么是sinatra</h2>

<p>Sinatra是一款非常轻量的Web框架，基于Ruby语言来开发的，其目的是以最小的精力为代价快速创建Web应用为目的的DSL（领域专属语言）。
Sinatra最大的特点就是非常轻量、快速。整个源码也只有1000行稍微多点。</p>

<h2>How to use Sinatra</h2>

<ul>
<li>首先需要保证你的系统已经安装了Ruby，至于怎么搭建Ruby环境，其实很简单，如果你使用的是Mac的话，首先你需要安装RVM，使用Rvm来管理你的Ruby，然后再安装Ruby，具体不做细说。</li>
<li>创建项目的的目录结构</li>
</ul>


<p><img src="/images/sinatra_1.png" alt="目录结构" /></p>

<ul>
<li>在Gemfile文件中引入需要使用的Gem包</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'rake'
</span><span class='line'>gem 'rack', '~&gt;1.5.2'
</span><span class='line'>gem 'json'
</span><span class='line'>gem 'rack-hal_browser'
</span><span class='line'>gem 'mysql2' # STENCIL_OPTIONAL: Database
</span><span class='line'>gem 'sinatra'
</span><span class='line'>gem 'sinatra-activerecord'
</span><span class='line'>gem 'sinatra-contrib'</span></code></pre></td></tr></table></div></figure>


<ul>
<li>运行bundle install</li>
<li>创建Rakefile文件
里边引入下面这段代码：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>require "sinatra/activerecord/rake"
</span><span class='line'>
</span><span class='line'>namespace :db do
</span><span class='line'>  task :load_config do
</span><span class='line'>    require "./app"
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>task :default =&gt; ['migrate']</span></code></pre></td></tr></table></div></figure>


<p>上边这段代码的目的是引入sinatra自己的rake任务，方便我们去做数据库迁移，如果还想自己去定义其他的rake任务可以继续往改文件里边添加
* 连接数据库，创建config/database.yml文件
在该文件中做如下的配置：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>development:
</span><span class='line'>  adapter: mysql2
</span><span class='line'>  host: 127.0.0.1
</span><span class='line'>  username: root
</span><span class='line'>  password:
</span><span class='line'>  database: developer-SEC-server</span></code></pre></td></tr></table></div></figure>


<p>本设置比较简单，只是创建了一个开发的数据库，你也可以创建你自己的test环境和产品环境
* 创建db/migrate目录结构
* 创建自己models目录结构
在该文件中你可以新建models，可以跟数据库表一一对应，看自己的需求
* 新建app.rb文件
这个文件是sinatra中的关键文件，在该文件中你可以定义自己对外提供的接口。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>require 'sinatra'
</span><span class='line'>require 'sinatra/json'
</span><span class='line'>require "sinatra/activerecord"
</span><span class='line'>require "./models/user"
</span><span class='line'>
</span><span class='line'>class DeveloperSECApp &lt; Sinatra::Base
</span><span class='line'>
</span><span class='line'>  register Sinatra::ActiveRecordExtension
</span><span class='line'>
</span><span class='line'>  post '/:login' do
</span><span class='line'>      response.headers['Access-Control-Allow-Origin'] = '*'
</span><span class='line'>      response.headers['Access-Control-Allow-Methods'] = 'POST'
</span><span class='line'>      user = User.find_by("developer_key=?", params['developer_key'])
</span><span class='line'>      @developer_key = params['developer_key']
</span><span class='line'>      if user.password == params['password']
</span><span class='line'>          puts params['password']
</span><span class='line'>          status 200
</span><span class='line'>
</span><span class='line'>      else
</span><span class='line'>          puts params['password']
</span><span class='line'>          status 400
</span><span class='line'>      end
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>上边的这段代码实现了一个简单地登录认证。</p>

<p>整个上边的过程，只是对sinatra的一个简单地demo，如果要在实际的项目中使用的话可以写出很复杂的应用，跟使用rails没有太大的区别，只是这个gem包更加的轻量，开发更快。</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-05-20T21:56:59+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2015/05/20/ruby-zhong-de-gou-zi-fang-fa/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://ucooling.github.io/blog/2015/05/20/ruby-zhong-de-gou-zi-fang-fa/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015/05/20/ruby-zhong-de-gou-zi-fang-fa/" itemprop="url">Ruby 中的钩子方法</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>以前从未对Ruby中的钩子方法有一个很深刻的认识，只是知道在使用的时候该去怎么引用，从看到了<a href="http://www.sitepoint.com/rubys-important-hook-methods/">这篇</a>文章之后我开始有了一个新的认识，也意识到自己对Ruby中的钩子方法的认识只是停留在一个很片面的层次，今天正好抽空总结一下。</p>

<h2>什么是钩子方法</h2>

<p>下面这段是对原文的翻译：
钩子方法提供当应用程序在运行时扩展应用程序的行为，假设有这样一种场景，当子类继承父类时父类能够接受到通知，或者是优雅地处理一个对象上的不可调用的方法而不是让编译器抛出异常。所有这些情况都是引用钩子方法的实例，但是他们的引用又不仅限于此，不同的框架或者库使用不同的钩子方法来实现他们的功能。</p>

<p>这篇文章中我们将讨论下面列表中的钩子方法：</p>

<ul>
<li>included</li>
<li>extended</li>
<li>prepended</li>
<li>inherited</li>
<li>method_missing</li>
</ul>


<h2>included</h2>

<p>Ruby提供了一种方法来使用定义在模块中的方法（模块在其他语言中被称作mixins）,模块的概念非常的简单，它是一种可以在其它地方使用的代码的集合。
例如我想写一个方法，当它被调用时能够返回一个静态的字符串，我们现在将这个方法叫做name,你可能在其它的地方同样也想使用这个那么方法，对于这样的场景，我们最后新建一个moudle,所以我们有了下面的代码：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>moudle Person
</span><span class='line'>  def name 
</span><span class='line'>    puts "My name is Person"
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>同时我们还有这样的一个类想要使用上面的moudle，我们可能会这样做</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class User
</span><span class='line'>  include Person
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>现在我们来执行上边的代码，看看我们会得到什么</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>User.new.name
</span><span class='line'>=&gt; My name is Person</span></code></pre></td></tr></table></div></figure>


<p>但是现在我们对moudle稍微做些修改，看看这其中的included钩子方法是如何被调用的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>moudle Person
</span><span class='line'>  def self.included(base)
</span><span class='line'>    puts "#{base} included #{self}"
</span><span class='line'>  end
</span><span class='line'>  
</span><span class='line'>  def name 
</span><span class='line'>    puts "My name is Person"
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>现在我们再来执行上边的代码，看看我们会得到什么</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>User.new.name
</span><span class='line'>=&gt; User included Person
</span><span class='line'>=&gt; My name is Person</span></code></pre></td></tr></table></div></figure>


<p>是的，正如我们所见，当我们在调用moudle中的方法的时候base返回的时包含改moudle得类名，当我们在调用moudle中的方法的时候会触发这里的included钩子方法。</p>

<h2>extended</h2>

<p>如果你经常写Ruby程序的话，有时候你可能会使用extend来引用一个moudle，使用这种方式跟使用include有很大的不同，当使用extend来引用moudle的时候，其实是将moudle中的方法作为类方法类引入，而使用include是作为实例方法来引入，这也就是为什么我们看到上边会使用User.new.name来调用name方法
下面同样是来自于原文的一个例子：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>module Person
</span><span class='line'>  def name
</span><span class='line'>    "My name is Person"
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>class User
</span><span class='line'>  extend Person
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>puts User.name # =&gt; My name is Person
</span><span class='line'>
</span><span class='line'>u1 = User.new
</span><span class='line'>u2 = User.new
</span><span class='line'>
</span><span class='line'>u1.extend Person
</span><span class='line'>
</span><span class='line'>puts u1.name # =&gt; My name is Person
</span><span class='line'>puts u2.name # =&gt; undefined method `name' for #&lt;User:0x007fb8aaa2ab38&gt; (NoMethodError)</span></code></pre></td></tr></table></div></figure>


<p>跟included类似，和extend对应的也有一个钩子方法extended.
当一个模块被其他模块或者类执行了extend操作的时候，就会触发该方法的调用。</p>

<h2>prepended</h2>

<p>另一种使用moudle内部方法的方式是prepend.这种方式被定义在ruby2.0中，它跟include和extend有很大的不同，使用include或者extend引入的方法可以在base类中重新覆盖，但是如果使用的是prepend方法引入moudle中的方法，那么它会覆盖base类中的同名方法，这样正好和include、extend相反。
下面是原文中的一个例子：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>module Person
</span><span class='line'>  def name
</span><span class='line'>    "My name belongs to Person"
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>class User
</span><span class='line'>  include Person
</span><span class='line'>  def name
</span><span class='line'>    "My name belongs to User"
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>puts User.new.name 
</span><span class='line'>=&gt; My name belongs to User</span></code></pre></td></tr></table></div></figure>


<p>再来看一下使用prepend的方式</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>module Person
</span><span class='line'>  def name
</span><span class='line'>    "My name belongs to Person"
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>class User
</span><span class='line'>  prepend Person
</span><span class='line'>  def name
</span><span class='line'>    "My name belongs to User"
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>puts User.new.name 
</span><span class='line'>=&gt; My name belongs to Person</span></code></pre></td></tr></table></div></figure>


<p>于prepend对应的也有一个钩子方法prepended方法</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>module Person
</span><span class='line'>  def self.prepended(base)
</span><span class='line'>    puts "#{self} prepended to #{base}"
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def name
</span><span class='line'>    "My name belongs to Person"
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>当上边一段代码执行时，会看到下面的结果</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Person prepended to User
</span><span class='line'>My name belongs to Person</span></code></pre></td></tr></table></div></figure>


<h2>inherited</h2>

<p>继承是面向对象中一个非常重要的概念，Ruby是一个面向对象的编程语言，提供了从base/parent继承一个子类的方法，下面是一个例子：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Person
</span><span class='line'>  def name
</span><span class='line'>     "My name is Person"
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'> 
</span><span class='line'>class User &lt; Person
</span><span class='line'>end
</span><span class='line'> 
</span><span class='line'>puts User.new.name # =&gt; My name is Person</span></code></pre></td></tr></table></div></figure>


<p>上边是一个非常简单地继承，你可能会很好奇，是什么时候会得到通知，当一个类继承另外一个类时，Ruby提供了一个叫做inherited的钩子方法，下面是一个例子：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Person
</span><span class='line'>  def self.inherited(child_class)
</span><span class='line'>    puts "#{child_class} inherits #{self}"
</span><span class='line'>  end
</span><span class='line'> 
</span><span class='line'>  def name
</span><span class='line'>    "My name is Person"
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'> 
</span><span class='line'>class User &lt; Person
</span><span class='line'>end
</span><span class='line'> 
</span><span class='line'>puts User.new.name</span></code></pre></td></tr></table></div></figure>


<p>执行上边这段代码会得到下面的输出</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>User inherits Person
</span><span class='line'>My name is Person</span></code></pre></td></tr></table></div></figure>


<h2>method_missing</h2>

<p>method_missing 可能是Ruby中使用最广的钩子。当我们试图去访问一个对象上不存在的方法时则会调用这个钩子方法。下面是一个简单地例子</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Person
</span><span class='line'>  def method_missing(sym, *args)
</span><span class='line'>     "#{sym} not defined on #{self}"
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def name
</span><span class='line'>    "My name is Person"
</span><span class='line'>  end
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>p = Person.new
</span><span class='line'>
</span><span class='line'>puts p.name     # =&gt; My name is Person
</span><span class='line'>puts p.address  # =&gt; address not defined on #&lt;Person:0x007fb2bb022fe0&gt;</span></code></pre></td></tr></table></div></figure>


<p>method_missing 接收两个参数：被调用的方法名和传递给该方法的参数。
首先Ruby会寻找我们试图调用的方法，如果方法没找到则会寻找 method_missing 方法。</p>

<p><em>声明：本文只是对原文做了部分的翻译，想看访问原文请看文章开始的链接。</em></p>
</div>
  
  


        </article>
      
    </div>

    <ul class="pager">
      
        <li class="previous"><a href="/posts/2">&larr;&nbsp;Older</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
        <li class="next disabled"><a href="#">Newer&nbsp;&rarr;</a></li>
      
    </ul>
  </div>
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits" style="text-align: center;">
  Copyright &copy; 2017 - Malrin
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'ucooling';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>








<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr.js"></script>


  </body>
</html>
